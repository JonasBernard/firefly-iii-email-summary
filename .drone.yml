kind: pipeline
type: docker
name: firefly update

steps:
- name: configure mail
  image: alpine
  settings:
    from.address:
      from_secret: ORG_MAIL_FROM_ADDRESS
    from.name:
      from_secret: ORG_MAIL_FROM_NAME
    host: 
      from_secret: ORG_MAIL_SMTP_SERVER
    recipients_only: true
    recipients:
      from_secret: ORG_MAIL_RECIPIENTS
    username:
      from_secret: ORG_MAIL_SMTP_USERNAME
    password:
      from_secret: ORG_MAIL_SMTP_PASSWORD
  commands:
  - "echo -e \"---\nsmtp:\n  server: $PLUGIN_HOST\n  port: 25\n  starttls: True\n  authentication: True\n  user: $PLUGIN_USERNAME\n  password: $PLUGIN_PASSWORD\nemail:\n  from: $PLUGIN_FROM.ADDRESS\n  to:\n    - $PLUGIN_RECIPIENTS\nfirefly-url: '$FIREFLY_URL'\naccesstoken: '$FIREFLY_TOKEN'\ncurrency: 'EUR'\" > config.yaml"
- name: send mail
  image: python
  commands:
  - pip install -r requirements.txt
  - python monthly-report.py
  depends_on:
  - configure mail

trigger:
  event:
    include:
    - promote
    - custom
    - cron
